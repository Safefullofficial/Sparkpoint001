<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SparkPoint - Децентрализованная Система</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.1/web3.min.js"></script>
    <style>
        :root {
            --primary: #00b8ff;
            --secondary: #00ff9d;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
        }
        .header, .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
        }
        .btn {
            background: linear-gradient(45deg, var(--primary), #0099d4);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn:hover { transform: scale(1.02); }
        .btn-admin { background: linear-gradient(45deg, #f59e0b, #d97706); }
        .tab-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #334155;
            border-radius: 8px;
        }
        .tab.active { background: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background: #334155;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-label { font-size: 0.8rem; color: #94a3b8; }
        .stat-value { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }
        .message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        .success { background: #065f46; color: #34d399; }
        .error { background: #7f1d1d; color: #f87171; }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #475569;
            background: #0f172a;
            color: white;
            box-sizing: border-box;
        }
        .level-section { margin-top: 20px; padding: 15px; border: 1px solid #334155; border-radius: 10px; }
        .circles-container { display: flex; gap: 10px; margin-top: 10px; }
        .circle {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        .circle-filled { background: var(--secondary); color: #0f172a; }
        .circle-empty { border: 2px solid #475569; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h1 style="margin:0; color:var(--primary);">SparkPoint</h1>
                <div id="userStatus" style="font-size: 0.9rem;">Не подключен</div>
            </div>
            <button id="connectWalletBtn" class="btn" onclick="connectWallet()">Подключить кошелек</button>
        </div>

        <div id="walletInfo" class="card" style="display:none;">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">Адрес</div>
                    <div id="walletAddress" class="stat-value">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Баланс</div>
                    <div id="walletBalance" class="stat-value">0 BNB</div>
                </div>
            </div>
        </div>

        <div class="tab-menu">
            <div class="tab active" data-tab="user" onclick="activateTab('user')">Кабинет</div>
            <div class="tab" data-tab="register" onclick="activateTab('register')">Регистрация</div>
            <div class="tab" data-tab="admin" id="adminTabBtn" style="display:none;" onclick="activateTab('admin')">Админ</div>
        </div>

        <div id="userTab" class="tab-content active">
            <div id="userStats" class="stat-grid">
                <div class="stat-card">Загрузка данных...</div>
            </div>
            <div class="card" style="margin-top:20px;">
                <h3>Ваша реферальная ссылка</h3>
                <input type="text" id="referralLink" readonly onclick="this.select()">
                <div id="globalMessage" class="message"></div>
            </div>
            <div id="levelsContainer"></div>
        </div>

        <div id="registerTab" class="tab-content">
            <div class="card">
                <h3>Регистрация в системе</h3>
                <p>Стоимость входа: 0.002 BNB</p>
                <label>Адрес пригласителя:</label>
                <input type="text" id="referrerAddressInput" placeholder="0x...">
                <button class="btn" style="width:100%" onclick="registerUser()">Зарегистрироваться</button>
                <div id="registerMessage" class="message"></div>
            </div>
        </div>

        <div id="adminTab" class="tab-content">
            <div class="card" style="border: 1px solid #f59e0b;">
                <h3>Панель управления</h3>
                <div id="adminStats" class="stat-grid"></div>
                <hr style="border: 0.5px solid #334155; margin: 20px 0;">
                <h4>Добавить участника бесплатно</h4>
                <input type="text" id="newUserAddress" placeholder="Адрес нового участника">
                <input type="text" id="newUserReferrer" placeholder="Адрес пригласителя">
                <button class="btn btn-admin" onclick="addUserByAdmin()">Добавить в структуру</button>
                <div id="addUserMessage" class="message"></div>
                <hr style="border: 0.5px solid #334155; margin: 20px 0;">
                <button class="btn btn-admin" onclick="withdrawAdminFees()">Вывести комиссии (10% + остатки)</button>
                <div id="withdrawMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        // --- КОНФИГУРАЦИЯ КОНТРАКТА ---
        const CONTRACT_ADDRESS = "0x8703D4e87CB01aEfCBe9ad39b0eEd257ce6b5684";
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"adminAddUser","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_referrer","type":"address"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_newAdmin","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[],"name":"withdrawAdminFees","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"stateMutability":"payable","type":"receive"},
            {"inputs":[],"name":"admin","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"ENTRY_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"thresholds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"uint256","name":"level","type":"uint256"},{"internalType":"address","name":"referrer","type":"address"},{"internalType":"uint256","name":"internalBalance","type":"uint256"},{"internalType":"uint256","name":"referralsInLevel","type":"uint256"},{"internalType":"uint256","name":"totalDirectReferrals","type":"uint256"},{"internalType":"uint256","name":"registrationTime","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"}
        ];

        const LEVEL_THRESHOLDS = { 1: 2, 2: 4, 3: 8, 4: 16, 5: 32 };

        let web3;
        let contract;
        let userAccount;
        let isAdmin = false;

        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                const urlParams = new URLSearchParams(window.search);
                if (urlParams.has('ref')) {
                    document.getElementById('referrerAddressInput').value = urlParams.get('ref');
                }
            } else {
                alert("Пожалуйста, установите MetaMask!");
            }
        }

        async function connectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                document.getElementById('walletAddress').textContent = shortenAddress(userAccount);
                document.getElementById('connectWalletBtn').textContent = 'Подключен';
                document.getElementById('walletInfo').style.display = 'block';
                
                const balance = await web3.eth.getBalance(userAccount);
                document.getElementById('walletBalance').textContent = parseFloat(web3.utils.fromWei(balance, 'ether')).toFixed(4) + ' BNB';
                
                await checkIfAdmin();
                await loadUserData();
                
                window.ethereum.on('accountsChanged', () => window.location.reload());
            } catch (error) {
                console.error(error);
            }
        }

        async function checkIfAdmin() {
            const adminAddr = await contract.methods.admin().call();
            isAdmin = (userAccount.toLowerCase() === adminAddr.toLowerCase());
            if (isAdmin) {
                document.getElementById('adminTabBtn').style.display = 'block';
                document.getElementById('userStatus').textContent = 'Администратор';
                document.getElementById('userStatus').style.color = '#f59e0b';
                loadAdminData();
            } else {
                document.getElementById('userStatus').textContent = 'Участник';
            }
        }

        async function loadUserData() {
            const userData = await contract.methods.users(userAccount).call();
            const statsDiv = document.getElementById('userStats');
            
            if (!userData.exists) {
                statsDiv.innerHTML = `<div class="stat-card" style="grid-column: 1/-1">Вы еще не зарегистрированы</div>`;
                return;
            }

            statsDiv.innerHTML = `
                <div class="stat-card"><div class="stat-label">Уровень</div><div class="stat-value">${userData.level}</div></div>
                <div class="stat-card"><div class="stat-label">Баланс (внутр.)</div><div class="stat-value">${web3.utils.fromWei(userData.internalBalance, 'ether')} BNB</div></div>
                <div class="stat-card"><div class="stat-label">Рефералы L1</div><div class="stat-value">${userData.totalDirectReferrals}/2</div></div>
                <div class="stat-card"><div class="stat-label">Прогресс уровня</div><div class="stat-value">${userData.referralsInLevel}/${LEVEL_THRESHOLDS[userData.level] || '?'}</div></div>
            `;
            
            document.getElementById('referralLink').value = `${window.location.origin}${window.location.pathname}?ref=${userAccount}`;
            updateUserLevels(userData);
        }

        function updateUserLevels(userData) {
            const container = document.getElementById('levelsContainer');
            let html = '';
            const currentLevel = parseInt(userData.level);
            
            for(let i=1; i<=3; i++) {
                const threshold = LEVEL_THRESHOLDS[i];
                const filled = (i === currentLevel) ? parseInt(userData.referralsInLevel) : (i < currentLevel ? threshold : 0);
                let circles = '';
                for(let j=0; j<threshold; j++) {
                    circles += `<div class="circle ${j < filled ? 'circle-filled' : 'circle-empty'}">${j < filled ? '✓' : j+1}</div>`;
                }
                html += `<div class="level-section"><strong>Уровень ${i}</strong><div class="circles-container">${circles}</div></div>`;
            }
            container.innerHTML = html;
        }

        async function registerUser() {
            const ref = document.getElementById('referrerAddressInput').value;
            if(!web3.utils.isAddress(ref)) return showMessage('Неверный адрес!', 'error', 'registerMessage');
            
            const price = await contract.methods.ENTRY_PRICE().call();
            contract.methods.register(ref).send({ from: userAccount, value: price })
                .on('receipt', () => {
                    showMessage('Успех!', 'success', 'registerMessage');
                    loadUserData();
                })
                .on('error', (e) => showMessage(e.message, 'error', 'registerMessage'));
        }

        async function loadAdminData() {
            const balance = await web3.eth.getBalance(CONTRACT_ADDRESS);
            document.getElementById('adminStats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Касса контракта</div><div class="stat-value">${web3.utils.fromWei(balance, 'ether')} BNB</div></div>
            `;
        }

        async function addUserByAdmin() {
            const user = document.getElementById('newUserAddress').value;
            const ref = document.getElementById('newUserReferrer').value;
            contract.methods.adminAddUser(user, ref).send({ from: userAccount })
                .on('receipt', () => showMessage('Пользователь добавлен!', 'success', 'addUserMessage'));
        }

        async function withdrawAdminFees() {
            contract.methods.withdrawAdminFees().send({ from: userAccount })
                .on('receipt', () => showMessage('Средства выведены!', 'success', 'withdrawMessage'));
        }

        function activateTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}Tab`).classList.add('active');
        }

        function showMessage(text, type, id) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = `message ${type}`;
            el.style.display = 'block';
        }

        function shortenAddress(addr) {
            return addr.substring(0,6) + '...' + addr.substring(addr.length-4);
        }

        window.onload = initWeb3;
    </script>
</body>
</html>

